# Architecture

## Monorepo Layout

The BKG repository is a polyglot monorepo with the following top-level areas:

| Path | Description |
| --- | --- |
<<<<<<< ours
| `core/backend/gateway` | NestJS 10 application that hosts the HTTP API, manages plug-in lifecycles, and exposes health/admin routes. |
| `core/frontend/admin-ui` | Angular 17 + Tailwind frontend that surfaces chat, plug-in controls, and administration tooling. |
| `core/plugins/llmserver` | Rust plug-in that wraps the llmserver runtime, exposes chat + embedding capabilities, and connects to the plug-in bus. |
| `core/plugins/repoagent` | Python FastAPI plug-in that hosts RepoAgent-like repository analysis and file patch workflows. |
| `core/plugins/apikeys` | NodeJS plug-in providing authentication, API key management, and scope enforcement against SQLite storage. |
| `devops/docker/` | Container build assets (Dockerfile, supervisord, Compose). |
| `devops/scripts/` | Operational helper scripts (startup, model download, diagnostics). |
=======
| `apps/bkg-api` | NestJS 10 application that hosts the HTTP API, manages plug-in lifecycles, and exposes health/admin routes. |
| `apps/bkg-web` | Angular 17 + Tailwind frontend that surfaces chat, plug-in controls, and administration tooling. |
| `plugins/llmserver` | Rust plug-in that wraps the llmserver runtime, exposes chat + embedding capabilities, and connects to the plug-in bus. |
| `plugins/repoagent` | Python FastAPI plug-in that hosts RepoAgent-like repository analysis and file patch workflows. |
| `plugins/apikeys` | NodeJS plug-in providing authentication, API key management, and scope enforcement against SQLite storage. |
| `docker/` | Container build assets (Dockerfile, supervisord, startup scripts). |
>>>>>>> theirs
| `models/` | Placeholder for GGUF model artefacts mounted at build time. |
| `docs/` | Documentation set covering architecture, plug-ins, deployment, and operations. |

## Runtime Topology

```
+--------------------+          +----------------------+
| Angular Frontend   |  HTTPS   | NestJS API Gateway   |
<<<<<<< ours
| (core/frontend/admin-ui)     +--------->+ (core/backend/gateway)       |
=======
| (apps/bkg-web)     +--------->+ (apps/bkg-api)       |
>>>>>>> theirs
+--------------------+          | - REST API           |
                                | - Plug-in lifecycle  |
                                | - SSE log streaming  |
                                +----------+-----------+
                                           |
                                WebSocket  |  BKG_PLUGIN_BUS_PORT
                                           v
                           +---------------+-------------------+
                           | Plug-in Bus & Process Supervisor |
                           +---------------+-------------------+
                                           |
             +-----------------------------+------------------------------+
             |                             |                              |
   +---------+---------+        +---------+---------+          +---------+---------+
   | llmserver (Rust)  |        | repoagent (Python)|          | apikeys (NodeJS) |
   | - Axum REST API   |        | - FastAPI server  |          | - Auth/Keys      |
   | - Chat/Embeddings |        | - Repo analysis   |          | - bcrypt hashing |
   +-------------------+        +-------------------+          +-------------------+
```

## Data Persistence

All persistent state is backed by SQLite (`/data/bkg.db`). Tables include:

- `users` – user directory with bcrypt-hashed credentials.
- `api_keys` – bcrypt-hashed API keys with JSON-encoded scopes and metadata.
- `plugins` – stored plug-in configuration, autostart flags, and capability declarations.
- `sessions` – ephemeral login sessions generated by the apikeys plug-in.

The NestJS API owns the SQLite connection (via `better-sqlite3`) and shares the path with plug-ins via the `BKG_DATABASE_PATH` environment variable.

## Plug-in Bus Protocol

The plug-in bus is a WebSocket server managed by the API host. Each plug-in connects and exchanges JSON envelopes:

- `register` – announces plug-in name, exposed capabilities, and listening port metadata.
- `request` / `response` – RPC-style invocation of capabilities with correlation IDs.
- `health` – heartbeat messages used for status tracking and the port table.
- `log` – structured log events streamed to the admin UI.

The API host relays capability invocations through the bus (`PluginService.invokeCapability`) and publishes log events via Server-Sent Events for the frontend.

## Port Allocation

Default port ranges avoid common development ports:

- `BKG_WEB_PORT` – defaults to `43117`.
- `BKG_API_PORT` – defaults to `43119` (dynamic if unset).
- `BKG_PLUGIN_BUS_PORT` – defaults to `43121` (dynamic if unset).

Each plug-in selects an available port (or marks itself `internal` if headless) and reports it to the bus for inclusion in the runtime port table.
