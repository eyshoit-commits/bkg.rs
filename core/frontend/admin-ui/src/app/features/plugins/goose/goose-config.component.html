<div class="space-y-6">
  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4">
    <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Allgemeine Einstellungen</h4>
    <div class="mt-3 grid gap-4 md:grid-cols-2">
      <label class="flex flex-col text-xs text-slate-300">
        Ziel-URL
        <input
          type="text"
          class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="editing.defaultTarget"
          (ngModelChange)="emitSettings()"
        />
      </label>
      <label class="flex flex-col text-xs text-slate-300">
        Nutzer (VU)
        <input
          type="number"
          min="1"
          class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="editing.users"
          (ngModelChange)="emitSettings()"
        />
      </label>
      <label class="flex flex-col text-xs text-slate-300">
        Ramp-Up (VU/s)
        <input
          type="number"
          min="1"
          class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="editing.hatchRate"
          (ngModelChange)="emitSettings()"
        />
      </label>
      <label class="flex flex-col text-xs text-slate-300">
        Laufzeit (Sekunden)
        <input
          type="number"
          min="1"
          class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="editing.runTimeSeconds"
          (ngModelChange)="emitSettings()"
        />
      </label>
      <label class="flex flex-col text-xs text-slate-300">
        Timeout (Sekunden)
        <input
          type="number"
          min="1"
          class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="editing.timeoutSeconds"
          (ngModelChange)="emitSettings()"
        />
      </label>
      <label class="flex items-center gap-2 text-xs text-slate-300">
        <input type="checkbox" [(ngModel)]="editing.verifyTls" (ngModelChange)="emitSettings()" />
        TLS-Zertifikate prüfen
      </label>
    </div>
  </section>

  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4">
    <div class="flex items-center justify-between">
      <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Globale Header</h4>
      <button class="rounded bg-primary px-3 py-1 text-xs font-semibold text-white" (click)="addGlobalHeader()">Header hinzufügen</button>
    </div>
    <div class="mt-3 space-y-3" *ngIf="globalHeaders.length > 0; else noHeaders">
      <div class="grid gap-3 md:grid-cols-[1fr_1fr_auto]" *ngFor="let header of globalHeaders; let i = index; trackBy: trackHeader">
        <input
          type="text"
          placeholder="Name"
          class="rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="header.key"
          (ngModelChange)="updateGlobalHeaders()"
        />
        <input
          type="text"
          placeholder="Wert"
          class="rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
          [(ngModel)]="header.value"
          (ngModelChange)="updateGlobalHeaders()"
        />
        <button class="rounded border border-rose-500/60 px-3 py-2 text-xs text-rose-200" (click)="removeGlobalHeader(i)">
          Entfernen
        </button>
      </div>
    </div>
    <ng-template #noHeaders>
      <p class="mt-3 text-xs text-slate-400">Noch keine globalen Header definiert.</p>
    </ng-template>
  </section>

  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4">
    <div class="flex items-center justify-between">
      <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Requests</h4>
      <button class="rounded bg-primary px-3 py-1 text-xs font-semibold text-white" (click)="addScheduleEntry()">
        Request hinzufügen
      </button>
    </div>
    <div class="mt-4 space-y-4" *ngIf="editing.schedule.length > 0; else noRequests">
      <div
        class="rounded-lg border border-slate-800 bg-slate-950/70 p-4 space-y-3"
        *ngFor="let entry of editing.schedule; let i = index; trackBy: trackSchedule"
      >
        <div class="grid gap-3 md:grid-cols-[120px_1fr_1fr_auto]">
          <input
            type="text"
            class="rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
            [(ngModel)]="entry.name"
            (ngModelChange)="emitSettings()"
            placeholder="Name"
          />
          <input
            type="text"
            class="rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
            [(ngModel)]="entry.method"
            (ngModelChange)="emitSettings()"
            placeholder="Methode"
          />
          <input
            type="text"
            class="rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
            [(ngModel)]="entry.path"
            (ngModelChange)="emitSettings()"
            placeholder="Pfad"
          />
          <button class="rounded border border-rose-500/60 px-3 py-2 text-xs text-rose-200" (click)="removeScheduleEntry(i)">
            Entfernen
          </button>
        </div>
        <div class="grid gap-3 md:grid-cols-3">
          <label class="flex flex-col text-xs text-slate-300">
            Gewichtung
            <input
              type="number"
              min="1"
              class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
              [(ngModel)]="entry.weight"
              (ngModelChange)="emitSettings()"
            />
          </label>
          <label class="flex flex-col text-xs text-slate-300">
            Denkpause (ms)
            <input
              type="number"
              min="0"
              class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
              [(ngModel)]="entry.thinkTimeMs"
              (ngModelChange)="emitSettings()"
            />
          </label>
          <label class="flex flex-col text-xs text-slate-300">
            Body
            <textarea
              rows="2"
              class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
              [(ngModel)]="entry.body"
              (ngModelChange)="emitSettings()"
            ></textarea>
          </label>
        </div>
        <div class="grid gap-3 md:grid-cols-2">
          <label class="flex flex-col text-xs text-slate-300">
            Request-Header (key=value pro Zeile)
            <textarea
              rows="3"
              class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
              [(ngModel)]="scheduleHeadersText[i]"
              (ngModelChange)="updateScheduleHeaders(i)"
              [ngModelOptions]="{ standalone: true }"
            ></textarea>
          </label>
          <label class="flex flex-col text-xs text-slate-300">
            Query-Parameter (key=value pro Zeile)
            <textarea
              rows="3"
              class="mt-1 rounded border border-slate-700 bg-slate-900 px-3 py-2 text-sm text-white"
              [(ngModel)]="scheduleQueriesText[i]"
              (ngModelChange)="updateScheduleQueries(i)"
              [ngModelOptions]="{ standalone: true }"
            ></textarea>
          </label>
        </div>
      </div>
    </div>
    <ng-template #noRequests>
      <p class="mt-3 text-xs text-slate-400">Noch keine Requests konfiguriert.</p>
    </ng-template>
  </section>

  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4 space-y-3">
    <div class="flex flex-wrap items-center gap-3">
      <button
        class="rounded bg-emerald-600/80 px-3 py-2 text-xs font-semibold text-white hover:bg-emerald-600 disabled:opacity-40"
        (click)="run()"
        [disabled]="loading || !canRun"
      >
        Testlauf starten
      </button>
      <button
        class="rounded bg-rose-600/80 px-3 py-2 text-xs font-semibold text-white hover:bg-rose-600 disabled:opacity-40"
        (click)="stop()"
        [disabled]="loading || !hasActiveRun"
      >
        Testlauf stoppen
      </button>
      <button class="rounded border border-slate-700 px-3 py-2 text-xs font-semibold text-slate-200" (click)="reload()">
        Status aktualisieren
      </button>
    </div>
    <p *ngIf="actionMessage" class="text-xs text-emerald-300">{{ actionMessage }}</p>
    <p *ngIf="actionError" class="text-xs text-rose-300">{{ actionError }}</p>
  </section>

  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4 space-y-3">
    <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Aktueller Status</h4>
    <div *ngIf="status; else noStatus" class="grid gap-3 md:grid-cols-2">
      <div class="rounded border border-slate-800 bg-slate-950/70 p-3 text-xs text-slate-300">
        <div><span class="text-slate-500">Status:</span> {{ status?.status }}</div>
        <div><span class="text-slate-500">Run ID:</span> {{ status?.runId || '–' }}</div>
        <div><span class="text-slate-500">Start:</span> {{ status?.startedAt | date: 'medium' }}</div>
        <div><span class="text-slate-500">Dauer:</span> {{ status?.durationSeconds | number: '1.0-1' }}s</div>
      </div>
      <div class="rounded border border-slate-800 bg-slate-950/70 p-3 text-xs text-slate-300">
        <div><span class="text-slate-500">Requests gesamt:</span> {{ status?.metrics.totalRequests }}</div>
        <div><span class="text-slate-500">Erfolgreich:</span> {{ status?.metrics.successRequests }}</div>
        <div><span class="text-slate-500">Fehler:</span> {{ status?.metrics.failedRequests }}</div>
        <div><span class="text-slate-500">Durchsatz:</span> {{ status?.metrics.requestsPerSecond | number: '1.1-1' }} req/s</div>
        <div><span class="text-slate-500">p95:</span> {{ status?.metrics.p95LatencyMs | number: '1.1-1' }} ms</div>
        <div><span class="text-slate-500">p99:</span> {{ status?.metrics.p99LatencyMs | number: '1.1-1' }} ms</div>
      </div>
    </div>
    <ng-template #noStatus>
      <p class="text-xs text-slate-400">Noch keine Statusinformationen verfügbar.</p>
    </ng-template>
  </section>

  <section class="rounded-xl border border-slate-800/70 bg-black/30 p-4">
    <h4 class="text-sm font-semibold uppercase tracking-wide text-slate-300">Historie</h4>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full text-left text-xs text-slate-300">
        <thead class="text-slate-500">
          <tr>
            <th class="px-3 py-2">Run ID</th>
            <th class="px-3 py-2">Status</th>
            <th class="px-3 py-2">Start</th>
            <th class="px-3 py-2">Dauer (s)</th>
            <th class="px-3 py-2">Requests</th>
            <th class="px-3 py-2">Fehler</th>
            <th class="px-3 py-2">p95</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let run of history">
            <td class="px-3 py-2 font-mono text-slate-200">{{ run.runId }}</td>
            <td class="px-3 py-2">{{ run.status }}</td>
            <td class="px-3 py-2">{{ run.startedAt | date: 'short' }}</td>
            <td class="px-3 py-2">{{ run.durationSeconds | number: '1.1-1' }}</td>
            <td class="px-3 py-2">{{ run.metrics.totalRequests }}</td>
            <td class="px-3 py-2">{{ run.metrics.failedRequests }}</td>
            <td class="px-3 py-2">{{ run.metrics.p95LatencyMs | number: '1.1-1' }} ms</td>
          </tr>
          <tr *ngIf="history.length === 0">
            <td class="px-3 py-2 text-slate-500" colspan="7">Noch keine historischen Läufe vorhanden.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </section>
</div>
